<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cost Sheet & Analysis</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container my-5">
      <h1 class="mb-4 text-center">Cost Sheet Preparation & Analysis</h1>
      <form id="costForm" class="card p-4 shadow">
        <div class="mb-3">
          <label class="form-label">Unit / Shop Name</label>
          <input type="text" name="unit_name" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">Business Type</label>
          <input
            type="text"
            name="business_type"
            class="form-control"
            required
          />
        </div>

        <div class="mb-3">
          <label class="form-label">Raw Materials Used</label>
          <textarea
            name="raw_materials"
            class="form-control"
            required
          ></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Monthly Raw Material Cost</label>
          <input
            type="number"
            name="raw_material_cost"
            min="0"
            class="form-control"
            required
          />
        </div>

        <div class="mb-3">
          <label class="form-label">Workers Employed</label>
          <input
            type="number"
            name="workers"
            min="0"
            class="form-control"
            required
          />
        </div>

        <div class="mb-3">
          <label class="form-label">Monthly Labor Cost</label>
          <input
            type="number"
            name="labor_cost"
            min="0"
            class="form-control"
            required
          />
        </div>

        <div class="mb-3">
          <label class="form-label">Overhead Expenses</label>
          <textarea name="overheads" class="form-control"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Monthly Overhead Cost</label>
          <input
            type="number"
            name="overhead_cost"
            min="0"
            class="form-control"
          />
        </div>

        <div class="mb-3">
          <label class="form-label">Monthly Production Units</label>
          <input
            type="number"
            name="production_units"
            min="0"
            class="form-control"
            required
          />
        </div>

        <div class="mb-3">
          <label class="form-label">Selling Price per Unit</label>
          <input
            type="number"
            name="selling_price"
            min="0"
            class="form-control"
            required
          />
        </div>

        <div class="mb-3">
          <label class="form-label">Challenges in Cost Control</label>
          <textarea name="challenges" class="form-control"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Suggestions to Reduce Costs</label>
          <textarea name="suggestions" class="form-control"></textarea>
        </div>

        <button type="submit" class="btn btn-primary w-100">Submit</button>
      </form>
      <div id="msg" class="mt-3 text-center"></div>
    </div>

    <script>
      function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
        document.cookie =
          name + "=" + value + ";expires=" + d.toUTCString() + ";path=/";
      }

      function getCookie(name) {
        const cname = name + "=";
        const decoded = decodeURIComponent(document.cookie);
        const ca = decoded.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i].trim();
          if (c.indexOf(cname) === 0)
            return c.substring(cname.length, c.length);
        }
        return "";
      }

      document
        .getElementById("costForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // Prevent multiple submissions via cookie
          if (getCookie("form_submitted")) {
            document.getElementById("msg").innerHTML =
              "<span class='text-warning'>⚠️ You already submitted!</span>";
            return;
          }

          const form = e.target;
          const data = {};

          [...form.elements].forEach((el) => {
            if (el.name) data[el.name] = el.value.trim();
          });

          const res = await fetch("/.netlify/functions/submitForm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (res.ok) {
            form.reset();
            setCookie("form_submitted", "yes", 1); // cookie valid for 1 day
            document.getElementById("msg").innerHTML = `
      <span class='text-success'>✅ Submitted successfully!</span>
      <br><a href="dashboard.html" class="btn btn-success mt-3">View Dashboard</a>
    `;
          } else {
            document.getElementById("msg").innerHTML =
              "<span class='text-danger'>❌ Submission failed.</span>";
          }
        });
    </script>
  </body>
</html>
